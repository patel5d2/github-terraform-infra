name: Auto Update Dependencies

on:
  schedule:
    # Run every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'requirements.txt'
      - 'Dockerfile'
      - '.github/workflows/**'

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge-dependabot:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for Dependabot PRs
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve patch and minor updates
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "âš ï¸ **Major version update detected!** Please review carefully before merging."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-dependencies:
    name: Check for Updates
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
        if: hashFiles('package.json') != ''

      - name: Check for npm updates
        if: hashFiles('package.json') != ''
        run: |
          echo "## NPM Dependencies Status" >> $GITHUB_STEP_SUMMARY
          npx npm-check-updates --format group >> $GITHUB_STEP_SUMMARY || true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
        if: hashFiles('requirements.txt') != ''

      - name: Check for pip updates
        if: hashFiles('requirements.txt') != ''
        run: |
          echo "## Python Dependencies Status" >> $GITHUB_STEP_SUMMARY
          pip list --outdated >> $GITHUB_STEP_SUMMARY || true

      - name: Create update summary
        run: |
          echo "âœ… Dependency check completed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Dependabot will create PRs for available updates" >> $GITHUB_STEP_SUMMARY

  docker-image-update-check:
    name: Check Docker Image Updates
    runs-on: ubuntu-latest
    if: hashFiles('Dockerfile') != ''
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for Docker base image updates
        run: |
          echo "## Docker Image Update Check" >> $GITHUB_STEP_SUMMARY
          if [ -f "Dockerfile" ]; then
            echo "âœ… Dockerfile found" >> $GITHUB_STEP_SUMMARY
            echo "Dependabot will monitor Docker base images" >> $GITHUB_STEP_SUMMARY
          fi
